<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8"/>
  <title>Bibliometría – Panel de Requerimientos</title>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <style>
    :root{
      --bg:#0b1220; --card:#111a2b; --muted:#b8c7ff; --text:#e9f0ff; --acc:#4ea1ff;
      --ok:#2ecc71; --err:#ff5c5c; --bor:#1f2a44;
    }
    *{box-sizing:border-box}
    body{margin:0; font-family:Inter,system-ui,Segoe UI,Roboto,Arial,sans-serif; background:var(--bg); color:var(--text)}
    header{padding:16px 24px; border-bottom:1px solid var(--bor)}
    h1{margin:0; font-size:20px}
    .wrap{max-width:1100px; margin:24px auto; padding:0 16px}
    .grid{display:grid; gap:16px}
    .panel{background:var(--card); border:1px solid var(--bor); border-radius:14px; padding:16px; box-shadow:0 8px 24px rgba(0,0,0,.25)}
    .panel h2{margin:0 0 8px 0; font-size:18px}
    .row{display:flex; gap:8px; flex-wrap:wrap; margin:8px 0 12px}
    input,textarea,button{border-radius:10px; border:1px solid var(--bor); background:#0b1529; color:var(--text); padding:10px 12px}
    button{background:var(--acc); border-color:#2e6dd6; cursor:pointer}
    button:disabled{opacity:.6; cursor:not-allowed}
    .out{white-space:pre-wrap; background:#0a1222; border:1px dashed #25365a; padding:12px; border-radius:10px; font-size:13px; overflow:auto; max-height:320px}
    table{width:100%; border-collapse:collapse; font-size:13px}
    th, td{border-bottom:1px solid #1f2a44; padding:8px 6px; text-align:left}
    .ok{color:var(--ok)} .err{color:var(--err)}
    .small{font-size:12px; color:var(--muted)}

    /* Galería */
    .gallery{display:grid; grid-template-columns: repeat(auto-fill, minmax(160px, 1fr)); gap:10px; margin-top:12px}
    .thumb{border:1px solid #1f2a44; border-radius:10px; overflow:hidden; background:#0a1222}
    .thumb a{display:block; text-decoration:none}
    .thumb img{display:block; width:100%; height:120px; object-fit:cover}
    .thumb .cap{font-size:12px; color:var(--muted); padding:6px 8px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis}

    /* PDFs */
    .pdfs{margin-top:10px}
    .pdfs a{color:var(--acc); text-decoration:none}
    .pdfs li{margin:4px 0}
  </style>
</head>
<body>
  <header><h1>Panel de Requerimientos – Bibliometría</h1></header>
  <div class="wrap grid">
    <!-- REQ 1 -->
    <section class="panel" id="p1">
      <h2>Requerimiento 1 – Automatización y Unificación</h2>
      <div class="row">
        <input id="q1" placeholder="Cadena de búsqueda (opcional)" style="min-width:300px">
        <button id="b1">Ejecutar</button>
      </div>
      <div class="small">Nota: si tus scrapers no usan consulta, la cadena se ignora.</div>
      <div class="out" id="o1"></div>
      <h3 style="margin-top:12px">Imágenes</h3>
      <div class="gallery" id="g1"></div>
      <h3>PDFs</h3>
      <ul class="pdfs" id="p1pdf"></ul>
    </section>

    <!-- REQ 2 -->
    <section class="panel" id="p2">
      <h2>Requerimiento 2 – Similitud Textual</h2>
      <div class="row">
        <input id="idx" placeholder="Índices separados por coma. Ej: 0,3,7" style="min-width:300px">
        <button id="b2">Ejecutar</button>
      </div>
      <div class="out" id="o2"></div>
      <h3 style="margin-top:12px">Top (CSV)</h3>
      <div id="t2"></div>
      <h3>Reporte (Markdown preview)</h3>
      <div class="out" id="md2"></div>
      <h3 style="margin-top:12px">Imágenes</h3>
      <div class="gallery" id="g2"></div>
      <h3>PDFs</h3>
      <ul class="pdfs" id="p2pdf"></ul>
    </section>

    <!-- REQ 3 -->
    <section class="panel" id="p3">
      <h2>Requerimiento 3 – Frecuencias & Palabras Asociadas</h2>
      <div class="row"><button id="b3">Ejecutar</button></div>
      <div class="out" id="o3"></div>
      <h3 style="margin-top:12px">Imágenes</h3>
      <div class="gallery" id="g3"></div>
      <h3>PDFs</h3>
      <ul class="pdfs" id="p3pdf"></ul>
    </section>

    <!-- REQ 4 -->
    <section class="panel" id="p4">
      <h2>Requerimiento 4 – Clustering Jerárquico</h2>
      <div class="row"><button id="b4">Ejecutar</button></div>
      <div class="out" id="o4"></div>
      <h3 style="margin-top:12px">Imágenes</h3>
      <div class="gallery" id="g4"></div>
      <h3>PDFs</h3>
      <ul class="pdfs" id="p4pdf"></ul>
    </section>

    <!-- REQ 5 -->
    <section class="panel" id="p5">
      <h2>Requerimiento 5 – Visual Analytics</h2>
      <div class="row"><button id="b5">Ejecutar</button></div>
      <div class="out" id="o5"></div>
      <h3 style="margin-top:12px">Imágenes</h3>
      <div class="gallery" id="g5"></div>
      <h3>PDFs</h3>
      <ul class="pdfs" id="p5pdf"></ul>
    </section>

    <!-- GRAFOS -->
    <section class="panel" id="pg">
      <h2>Seguimiento 2 – Grafos</h2>
      <div class="row">
        <button id="bg1">Grafo de Citaciones</button>
        <button id="bg2">Grafo de Términos</button>
      </div>
      <div class="out" id="og"></div>
      <h3 style="margin-top:12px">Imágenes</h3>
      <div class="gallery" id="gg"></div>
      <h3>PDFs</h3>
      <ul class="pdfs" id="pgpdf"></ul>
    </section>
  </div>

  <!-- showdown para previsualizar markdown -->
  <script src="https://cdn.jsdelivr.net/npm/showdown@2.1.0/dist/showdown.min.js"></script>
  <script>
  const o1 = document.getElementById('o1');
  const o2 = document.getElementById('o2');
  const t2 = document.getElementById('t2');
  const md2 = document.getElementById('md2');
  const o3 = document.getElementById('o3');
  const o4 = document.getElementById('o4');
  const o5 = document.getElementById('o5');
  const og = document.getElementById('og');

  function galleryHTML(items){
    if(!items || !items.length) return "<div class='small'>No hay imágenes.</div>";
    return items.map(it=>{
      const href = `/files/${encodeURIComponent(it.rel)}`;
      const cap  = it.name;
      return `
        <div class="thumb">
          <a href="${href}" target="_blank" rel="noopener">
            <img src="${href}" alt="${cap}">
            <div class="cap">${cap}</div>
          </a>
        </div>`;
    }).join("");
  }

  function pdfListHTML(items){
    if(!items || !items.length) return "<li class='small'>No hay PDFs.</li>";
    return items.map(it=>{
      const href = `/files/${encodeURIComponent(it.rel)}`;
      const kb = Math.max(1, Math.round((it.bytes || 0)/1024));
      return `<li><a href="${href}" target="_blank" rel="noopener">${it.name}</a> <span class="small">(${kb} KB)</span></li>`;
    }).join("");
  }

  async function loadScope(targetImgsId, targetPdfsId, scope){
    const r = await fetch(`/api/list_assets?scope=${encodeURIComponent(scope)}&limit=24`);
    const j = await r.json();
    const items = j.items || {};
    document.getElementById(targetImgsId).innerHTML = galleryHTML(items.images || []);
    document.getElementById(targetPdfsId).innerHTML = pdfListHTML(items.pdfs || []);
  }

  // ---- Acciones ----
  document.getElementById('b1').onclick = async ()=>{
    const q = document.getElementById('q1').value || "";
    o1.textContent = "Ejecutando Req1...";
    const r = await fetch('/api/req1', {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({query:q})});
    const j = await r.json();
    o1.textContent = (j.ok ? j.stdout : (j.stderr || j.stdout || 'Error'));
    loadScope('g1','p1pdf','req1');
  };

  document.getElementById('b2').onclick = async ()=>{
    const idx = (document.getElementById('idx').value || '').split(',').map(s=>parseInt(s.trim(),10)).filter(n=>!isNaN(n));
    o2.textContent = "Ejecutando Req2...";
    t2.innerHTML = ""; md2.textContent = "";
    const r = await fetch('/api/req2', {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({indices:idx})});
    const j = await r.json();
    o2.textContent = (j.ok ? j.stdout : (j.stderr || j.stdout || 'Error'));
    if(j.ok){
      // CSV
      if(j.table && j.table.length){
        const cols = Object.keys(j.table[0]);
        let html = "<table><thead><tr>";
        cols.forEach(c=> html += `<th>${c}</th>`);
        html += "</tr></thead><tbody>";
        j.table.forEach(r=>{
          html += "<tr>";
          cols.forEach(c=> html += `<td>${(r[c]??"")}</td>`);
          html += "</tr>";
        });
        html += "</tbody></table>";
        t2.innerHTML = html;
      }
      // MD
      if(j.md){
        const conv = new showdown.Converter();
        md2.innerHTML = conv.makeHtml(j.md);
      }
      loadScope('g2','p2pdf','req2');
    }
  };

  document.getElementById('b3').onclick = async ()=>{
    o3.textContent = "Ejecutando Req3...";
    const r = await fetch('/api/req3', {method:'POST'});
    const j = await r.json();
    o3.textContent = (j.ok ? (j.stdout || JSON.stringify(j.result,null,2)) : (j.stderr || j.stdout || 'Error'));
    loadScope('g3','p3pdf','req3');
  };

  document.getElementById('b4').onclick = async ()=>{
    o4.textContent = "Ejecutando Req4...";
    const r = await fetch('/api/req4', {method:'POST'});
    const j = await r.json();
    o4.textContent = (j.ok ? j.stdout : (j.stderr || j.stdout || 'Error'));
    loadScope('g4','p4pdf','req4');
  };

  document.getElementById('b5').onclick = async ()=>{
    o5.textContent = "Ejecutando Req5...";
    const r = await fetch('/api/req5', {method:'POST'});
    const j = await r.json();
    o5.textContent = (j.ok ? j.stdout : (j.stderr || j.stdout || 'Error'));
    loadScope('g5','p5pdf','req5');
  };

  document.getElementById('bg1').onclick = async ()=>{
    og.textContent = "Ejecutando Grafo de Citaciones...";
    const r = await fetch('/api/grafos/cit', {method:'POST'});
    const j = await r.json();
    og.textContent = (j.ok ? j.stdout : (j.stderr || j.stdout || 'Error'));
    loadScope('gg','pgpdf','grafos_cit');
  };

  document.getElementById('bg2').onclick = async ()=>{
    og.textContent = "Ejecutando Grafo de Términos...";
    const r = await fetch('/api/grafos/terms', {method:'POST'});
    const j = await r.json();
    og.textContent = (j.ok ? j.stdout : (j.stderr || j.stdout || 'Error'));
    loadScope('gg','pgpdf','grafos_terms');
  };

  // Carga inicial por scope (por si ya hay resultados)
  loadScope('g1','p1pdf','req1');
  loadScope('g2','p2pdf','req2');
  loadScope('g3','p3pdf','req3');
  loadScope('g4','p4pdf','req4');
  loadScope('g5','p5pdf','req5');
  loadScope('gg','pgpdf','grafos_cit');
  </script>
</body>
</html>
